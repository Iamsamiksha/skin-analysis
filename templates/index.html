<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Face Age Prediction</title>
  <style>
      body { font-family: Arial, sans-serif; text-align: center; }
      input[type="file"], input[type="number"], select { margin: 20px 0; }
      button { padding: 10px 20px; cursor: pointer; }
      img { width: 300px; height: auto; margin: 20px 0; }
  </style>
</head>
<body>
  <h1>Upload or Capture a Photo for Age Prediction</h1>

  <!-- Age and Skin Type Section -->
  <h3>Enter Your Age and Skin Type</h3>
  <form id="ageForm">
    <label for="age">Age:</label>
    <input type="number" id="age" name="age" min="0" max="120" required>
    
    <label for="skinType">Skin Type:</label>
    <select id="skinType" name="skinType" required>
        <option value="dry">Dry</option>
        <option value="oily">Oily</option>
        <option value="both">Both</option>
    </select>

    <label for="gender">Gender:</label>
    <select id="gender" name="gender" required>
        <option value="male">Male</option>
        <option value="female">Female</option>
    </select>
    
    <button type="submit">Submit Age and Skin Type</button>
  </form>

  <!-- Image Upload Section -->
  <h3>Upload an Image</h3>
  <form id="uploadForm" enctype="multipart/form-data">
      <input type="file" name="file" id="fileInput" accept="image/*">
      <button type="submit">Upload Image</button>
  </form>

  <!-- Webcam Capture Section -->
  <h3>Capture from Webcam</h3>
  <video id="webcam" width="300" height="200" autoplay></video>
  <br>
  <button onclick="captureImage()">Capture Image</button>

  <!-- Results -->
  <h3>Prediction Result</h3>
  <div id="result"></div>
  <img id="uploadedImage" src="" alt="Uploaded or Captured Image">

  <script>
    let age = null;
    let skinType = null;
    let gender = null;

    // Capture Age, Skin Type, and Gender from the form
    document.getElementById("ageForm").addEventListener("submit", function(event) {
        event.preventDefault();
        age = document.getElementById("age").value;
        skinType = document.getElementById("skinType").value;
        gender = document.getElementById("gender").value;
        alert(`Age: ${age}, Skin Type: ${skinType}, Gender: ${gender} saved!`);
    });

    const video = document.getElementById("webcam");
    const constraints = { video: { facingMode: "user" } };
  
    navigator.mediaDevices.getUserMedia(constraints)
        .then((stream) => { video.srcObject = stream; })
        .catch((error) => { alert("Error accessing webcam: " + error); });
  
    function captureImage() {
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;
        const context = canvas.getContext("2d");
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = canvas.toDataURL("image/jpeg");
  
        document.getElementById('result').innerText = "Processing...";
        
        fetch('/upload_webcam', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: imageData, age: age, skinType: skinType, gender: gender })
        })
        .then(response => response.json())
        .then(data => {
            if (data.age !== undefined) {
                document.getElementById('result').innerText = `Predicted Age: ${data.age}`;
            } else if (data.error) {
                document.getElementById('result').innerText = `Error: ${data.error}`;
            } else {
                document.getElementById('result').innerText = "No age prediction returned.";
            }
            document.getElementById('uploadedImage').src = imageData;
        })
        .catch(error => {
            console.log("Error:", error);
            document.getElementById('result').innerText = "Server error. Try again.";
        });
    }
  
    document.getElementById("uploadForm").addEventListener("submit", function(event) {
        event.preventDefault();
        const fileInput = document.getElementById("fileInput");
        if (fileInput.files.length === 0) {
            alert("Please select a file to upload.");
            return;
        }
  
        const formData = new FormData();
        formData.append("file", fileInput.files[0]);
        formData.append("age", age);  // Append the age
        formData.append("skinType", skinType);  // Append the skin type
        formData.append("gender", gender);  // Append the gender
        
        document.getElementById('result').innerText = "Processing...";
  
        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.age !== undefined) {
                document.getElementById('result').innerText = `Predicted Age: ${data.age}`;
            } else if (data.error) {
                document.getElementById('result').innerText = `Error: ${data.error}`;
            } else {
                document.getElementById('result').innerText = "No age prediction returned.";
            }
            document.getElementById('uploadedImage').src = URL.createObjectURL(fileInput.files[0]);
        })
        .catch(error => {
            console.log("Error:", error);
            document.getElementById('result').innerText = "Server error. Try again.";
        });
    });
  </script>
</body>
</html>
